FLUX TRANSFORMER: COMPLETE DATA FLOW ARCHITECTURE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

INPUT STAGE: MULTI-MODAL CONDITIONING & EMBEDDING
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                                                             â”‚
â”‚    VISUAL INPUT PIPELINE                  TEXT INPUT PIPELINE                     TEMPORAL CONDITIONING     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚ â”‚ RGB Image           â”‚                  â”‚ Text Prompt         â”‚                â”‚ Timestep t âˆˆ [0,1]  â”‚     â”‚
â”‚ â”‚ [B, 3, H, W]        â”‚                  â”‚ "A beautiful beach" â”‚                â”‚ Guidance strength   â”‚     â”‚
â”‚ â”‚ e.g., [1,3,1024,1024]â”‚                 â”‚ List[str]           â”‚                â”‚ [B] tensors         â”‚     â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€      â”‚
â”‚         â”‚                                          â”‚                                     â”‚                  â”‚
â”‚         â–¼                                          â–¼                                     â–¼                  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚ â”‚ VAE Encoder         â”‚                  â”‚ DUAL TEXT ENCODERS  â”‚                â”‚ Sinusoidal Embeddingâ”‚     â”‚
â”‚ â”‚ autoencoder.py:309  â”‚                  â”‚ conditioner.py      â”‚                â”‚ timestep_embedding()â”‚     â”‚
â”‚ â”‚ Conv2d layers       â”‚                  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                â”‚ layers.py:28-49     â”‚     â”‚
â”‚ â”‚ ResNet + Attention  â”‚                  â”‚ â”‚ T5 Encoder      â”‚ â”‚                â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚     â”‚
â”‚ â”‚ 3 â†’ 16 channels     â”‚                  â”‚ â”‚ Sequential emb  â”‚ â”‚                â”‚ â”‚ freqs = exp(-logâ”‚ â”‚     â”‚
â”‚ â”‚ H,W â†’ H/8, W/8      â”‚                  â”‚ â”‚ max_len=512     â”‚ â”‚                â”‚ â”‚ (10000)*range/  â”‚ â”‚     â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚ â”‚ [B,512,4096]    â”‚ â”‚                â”‚ â”‚ half) * 1000    â”‚ â”‚     â”‚
â”‚         â”‚                                â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                â”‚ â”‚ cos/sin args    â”‚ â”‚     â”‚
â”‚         â–¼                                â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚ â”‚ CLIP Encoder    â”‚ â”‚                â”‚ [B, 256]            â”‚     â”‚
â”‚ â”‚ VAE Latent Space    â”‚                  â”‚ â”‚ Pooled vector   â”‚ â”‚                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚ â”‚ [B, 16, H/8, W/8]   â”‚                  â”‚ â”‚ max_len varies  â”‚ â”‚                         â”‚                  â”‚
â”‚ â”‚ e.g.,[1,16,128,128] â”‚                  â”‚ â”‚ [B, 768]        â”‚ â”‚                         â–¼                  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚         â”‚                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚ MLPEmbedder         â”‚     â”‚
â”‚         â–¼                                          â”‚                            â”‚ time_in: 256â†’hidden â”‚     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â–¼                            â”‚ Linearâ†’SiLUâ†’Linear  â”‚     â”‚
â”‚ â”‚ Patch Embedding     â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚ model.py:61         â”‚     â”‚
â”‚ â”‚ sampling.py:41      â”‚                  â”‚ Text Conditioning   â”‚                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚ â”‚ rearrange operation â”‚                  â”‚ Split Processing    â”‚                         â”‚                  â”‚
â”‚ â”‚ "b c (h ph) (w pw)  â”‚                  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                         â–¼                  â”‚
â”‚ â”‚ -> b (h w)(c ph pw)"â”‚                  â”‚ â”‚ T5 â†’ txt_in     â”‚ â”‚                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚ â”‚ ph=2, pw=2          â”‚                  â”‚ â”‚ Linear(4096,    â”‚ â”‚                â”‚ Guidance Embedding  â”‚     â”‚
â”‚ â”‚ 16Ã—4 = 64 chan      â”‚                  â”‚ â”‚       hidden)   â”‚ â”‚                â”‚ guidance_in  if usedâ”‚     â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚ â”‚ model.py:66     â”‚ â”‚                â”‚ 256â†’hidden_size     â”‚     â”‚
â”‚         â”‚                                â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                â”‚ model.py:63-65      â”‚     â”‚
â”‚         â–¼                                â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚ â”‚ CLIP â†’ vec_in   â”‚ â”‚                         â”‚                  â”‚
â”‚ â”‚ Spatial Indexing    â”‚                  â”‚ â”‚ MLPEmbedder     â”‚ â”‚                         â–¼                  â”‚
â”‚ â”‚ sampling.py:45-48   â”‚                  â”‚ â”‚ (768, hidden)   â”‚ â”‚                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚ â”‚ img_ids creation    â”‚                  â”‚ â”‚ model.py:64     â”‚ â”‚                â”‚ Vector Combination   â”‚    â”‚
â”‚ â”‚ [h//2, w//2, 3]     â”‚                  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                â”‚ vec = time_emb +     â”‚    â”‚
â”‚ â”‚ (...,1)=h, (...,2)=wâ”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚       guidance_emb + â”‚    â”‚
â”‚ â”‚ [B, HÃ—W/4, 3]       â”‚                            â”‚                            â”‚       vector_in(clip)â”‚    â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â–¼                            â”‚ [B, hidden_size]     â”‚    â”‚
â”‚         â”‚                                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚         â–¼                                â”‚ Text Token Sequence â”‚                         â”‚                  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚ [B, 512, hidden]    â”‚                         â”‚                  â”‚
â”‚ â”‚ Visual Embedding    â”‚                  â”‚ txt_ids=[B,512,3]   â”‚                         â”‚                  â”‚
â”‚ â”‚ img_in = Linear     â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚                  â”‚
â”‚ â”‚ (64, hidden_size)   â”‚                            â”‚                                     â”‚                  â”‚
â”‚ â”‚ model.py:60         â”‚                            â”‚                                     â”‚                  â”‚
â”‚ â”‚ bias=True           â”‚                            â”‚                                     â”‚                  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚                                     â”‚                  â”‚
â”‚         â”‚                                          â”‚                                     â”‚                  â”‚
â”‚         â–¼                                          â”‚                                     â”‚                  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚                                     â”‚                  â”‚
â”‚ â”‚ Visual Token Seq    â”‚                            â”‚                                     â”‚                  â”‚
â”‚ â”‚ [B, HÃ—W/4, hidden]  â”‚                            â”‚                                     â”‚                  â”‚
â”‚ â”‚ img_ids=[B,HÃ—W/4,3] â”‚                            â”‚                                     â”‚                  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚                                     â”‚                  â”‚
â”‚         â”‚                                          â”‚                                     â”‚                  â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                     â”‚                  â”‚
â”‚                          â–¼                                                               â”‚                  â”‚
â”‚                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                   â”‚                  â”‚
â”‚                â”‚ ID Concatenation    â”‚ â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                â”‚ ids = torch.cat(    â”‚                                                                      â”‚
â”‚                â”‚   (txt_ids,img_ids),â”‚                                                                      â”‚
â”‚                â”‚   dim=1)            â”‚                                                                      â”‚
â”‚                â”‚ [B,512+HÃ—W/4,3]     â”‚                                                                      â”‚
â”‚                â”‚ model.py:107        â”‚                                                                      â”‚
â”‚                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                                      â”‚
â”‚                          â”‚                                                                                  â”‚
â”‚                          â–¼                                                                                  â”‚
â”‚                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                                      â”‚
â”‚                â”‚ Positional Encoding â”‚                                                                      â”‚
â”‚                â”‚ pe_embedder(ids)    â”‚                                                                      â”‚
â”‚                â”‚ EmbedND: RoPE       â”‚                                                                      â”‚
â”‚                â”‚ Rotary 2D spatial   â”‚                                                                      â”‚
â”‚                â”‚ pe: [B,1,seq,head]  â”‚                                                                      â”‚
â”‚                â”‚ model.py:108        â”‚                                                                      â”‚
â”‚                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

DUAL-STREAM PROCESSING: 19 Ã— DoubleStreamBlock
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ for block in self.double_blocks:  # model.py:110                                                            â”‚
â”‚     img, txt = block(img=img, txt=txt, vec=vec, pe=pe)                                                      â”‚
â”‚                                                                                                             â”‚
â”‚    EACH DoubleStreamBlock (layers.py:129-191):                                                              â”‚
â”‚                                                                                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚ â”‚ IMG STREAM          â”‚                          â”‚ TXT STREAM          â”‚                                    â”‚
â”‚ â”‚ [B, HÃ—W/4, hidden]  â”‚                          â”‚ [B, 512, hidden]    â”‚                                    â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â”‚         â”‚                                                  â”‚                                                â”‚
â”‚         â–¼                                                  â–¼                                                â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚ â”‚ Vector Modulation   â”‚    â”‚ Vector Conditioning â”‚    â”‚ Vector Modulation   â”‚                               â”‚
â”‚ â”‚ img_mod1, img_mod2  â”‚    â”‚ vec: [B, hidden]    â”‚    â”‚ txt_mod1, txt_mod2  â”‚                               â”‚
â”‚ â”‚ = img_mod(vec)      â”‚    â”‚ Combined time+guid+ â”‚    â”‚ = txt_mod(vec)      â”‚                               â”‚
â”‚ â”‚ Returns:            â”‚    â”‚ CLIP pooled vectors â”‚    â”‚ Returns:            â”‚                               â”‚
â”‚ â”‚ â€¢ shift, scale, gateâ”‚ â†â”€â”€â”¤ Broadcast to all    â”‚â”€â”€â†’ â”‚ â€¢ shift, scale, gateâ”‚                               â”‚
â”‚ â”‚ â€¢ For attn & mlp    â”‚    â”‚ components          â”‚    â”‚ â€¢ For attn & mlp    â”‚                               â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚         â”‚                                                  â”‚                                                â”‚
â”‚         â–¼                                                  â–¼                                                â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚ â”‚ Adaptive LayerNorm  â”‚                          â”‚ Adaptive LayerNorm  â”‚                                    â”‚
â”‚ â”‚ img_norm = LayerNormâ”‚                          â”‚ txt_norm = LayerNormâ”‚                                    â”‚
â”‚ â”‚ (elementwise_affine â”‚                          â”‚ (elementwise_affine â”‚                                    â”‚
â”‚ â”‚  =False)            â”‚                          â”‚  =False)            â”‚                                    â”‚
â”‚ â”‚ img_mod = (1+scale) â”‚                          â”‚ txt_mod = (1+scale) â”‚                                    â”‚
â”‚ â”‚ * norm(img) + shift â”‚                          â”‚ * norm(txt) + shift â”‚                                    â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â”‚         â”‚                                                  â”‚                                                â”‚
â”‚         â–¼                                                  â–¼                                                â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚ â”‚ QKV Computation     â”‚                          â”‚ QKV Computation     â”‚                                    â”‚
â”‚ â”‚ qkv = Linear        â”‚                          â”‚ qkv = Linear        â”‚                                    â”‚
â”‚ â”‚ (hidden, 3*hidden,  â”‚                          â”‚ (hidden, 3*hidden,  â”‚                                    â”‚
â”‚ â”‚  bias=qkv_bias)     â”‚                          â”‚  bias=qkv_bias)     â”‚                                    â”‚
â”‚ â”‚ img_q,img_k,img_v = â”‚                          â”‚ txt_q,txt_k,txt_v = â”‚                                    â”‚
â”‚ â”‚ rearrange(qkv,      â”‚                          â”‚ rearrange(qkv,      â”‚                                    â”‚
â”‚ â”‚ "B L (K H D)->      â”‚                          â”‚ "B L (K H D)->      â”‚                                    â”‚
â”‚ â”‚  K B H L D", K=3)   â”‚                          â”‚  K B H L D", K=3)   â”‚                                    â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â”‚         â”‚                                                  â”‚                                                â”‚
â”‚         â–¼                                                  â–¼                                                â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚ â”‚ QK Normalization    â”‚                          â”‚ QK Normalization    â”‚                                    â”‚
â”‚ â”‚ img_q,img_k=norm(q,kâ”‚                          â”‚ txt_q,txt_k=norm(q,kâ”‚                                    â”‚
â”‚ â”‚ RMSNorm per head    â”‚                          â”‚ RMSNorm per head    â”‚                                    â”‚
â”‚ â”‚ Stabilizes training â”‚                          â”‚ Stabilizes training â”‚                                    â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â”‚         â”‚                                                  â”‚                                                â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                â”‚
â”‚                          â–¼                                                                                  â”‚
â”‚                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                                      â”‚
â”‚                â”‚  CROSS-MODAL        â”‚                                                                      â”‚
â”‚                â”‚ ATTENTION           â”‚                                                                      â”‚
â”‚                â”‚ q = cat(txt_q,img_q)â”‚ â† KEY INNOVATION: Joint attention!                                   â”‚
â”‚                â”‚ k = cat(txt_k,img_k)â”‚                                                                      â”‚
â”‚                â”‚ v = cat(txt_v,img_v)â”‚                                                                      â”‚
â”‚                â”‚ attn = attention(   â”‚                                                                      â”‚
â”‚                â”‚   q,k,v,pe=pe)      â”‚                                                                      â”‚
â”‚                â”‚ [B,H,txt+img,D]     â”‚                                                                      â”‚
â”‚                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                                      â”‚
â”‚                          â”‚                                                                                  â”‚
â”‚                          â–¼                                                                                  â”‚
â”‚                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                                      â”‚
â”‚                â”‚ ATTENTION SPLIT     â”‚                                                                      â”‚
â”‚                â”‚ txt_attn, img_attn  â”‚                                                                      â”‚
â”‚                â”‚ = attn.split(       â”‚                                                                      â”‚
â”‚                â”‚   [txt.shape[1],    â”‚                                                                      â”‚
â”‚                â”‚    img.shape[1]])   â”‚                                                                      â”‚
â”‚                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                                      â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                                â”‚
â”‚         â–¼                                  â–¼                                                                â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                    â”‚
â”‚ â”‚ IMG RESIDUAL CONN   â”‚          â”‚ TXT RESIDUAL CONN   â”‚                                                    â”‚
â”‚ â”‚ img = img +         â”‚          â”‚ txt = txt +         â”‚                                                    â”‚
â”‚ â”‚   img_mod1.gate *   â”‚          â”‚   txt_mod1.gate *   â”‚                                                    â”‚
â”‚ â”‚   proj(img_attn)    â”‚          â”‚   proj(txt_attn)    â”‚                                                    â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                    â”‚
â”‚         â”‚                                  â”‚                                                                â”‚
â”‚         â–¼                                  â–¼                                                                â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                    â”‚
â”‚ â”‚ IMG MLP BLOCK       â”‚          â”‚ TXT MLP BLOCK       â”‚                                                    â”‚
â”‚ â”‚ mlp_input = (1+     â”‚          â”‚ mlp_input = (1+     â”‚                                                    â”‚
â”‚ â”‚   img_mod2.scale) * â”‚          â”‚   txt_mod2.scale) * â”‚                                                    â”‚
â”‚ â”‚   norm2(img) +      â”‚          â”‚   norm2(txt) +      â”‚                                                    â”‚
â”‚ â”‚   img_mod2.shift    â”‚          â”‚   txt_mod2.shift    â”‚                                                    â”‚
â”‚ â”‚ mlp = Linearâ†’GELUâ†’  â”‚          â”‚ mlp = Linearâ†’GELUâ†’  â”‚                                                    â”‚
â”‚ â”‚       Linear        â”‚          â”‚       Linear        â”‚                                                    â”‚
â”‚ â”‚ img = img +         â”‚          â”‚ txt = txt +         â”‚                                                    â”‚
â”‚ â”‚   img_mod2.gate *   â”‚          â”‚   txt_mod2.gate *   â”‚                                                    â”‚
â”‚ â”‚   mlp(mlp_input)    â”‚          â”‚   mlp(mlp_input)    â”‚                                                    â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                    â”‚
â”‚         â”‚                                  â”‚                                                                â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                                â”‚
â”‚                          â–¼                                                                                  â”‚
â”‚                    (img, txt) output                                                                        â”‚
â”‚                                                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

STREAM FUSION: Concatenation Strategy
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ # CRITICAL OPERATION: model.py:113                                                                          â”‚
â”‚ img = torch.cat((txt, img), 1)                                                                              â”‚
â”‚                                                                                                             â”‚
â”‚  TENSOR SHAPES:                                                                                             â”‚
â”‚ â€¢ txt: [B, 512, hidden_size]        â† Text tokens (always first!)                                           â”‚
â”‚ â€¢ img: [B, HÃ—W/4, hidden_size]      â† Visual tokens (appended)                                              â”‚
â”‚ â€¢ Result: [B, 512 + HÃ—W/4, hidden_size] â† Unified sequence                                                  â”‚
â”‚                                                                                                             â”‚
â”‚  MEMORY LAYOUT:                                                                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Index:  0    1    2  ...  511  512  513  514  ...  511+HÃ—W/4                                            â”‚ â”‚
â”‚ â”‚ Content:[txt][txt][txt]...[txt][img][img][img]...[img]                                                  â”‚ â”‚
â”‚ â”‚ Type:   TEXT_TOKEN_SEQUENCE    |   VISUAL_TOKEN_SEQUENCE                                                â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â€¢ Visual tokens start at index txt.shape[1] = 512                                                           â”‚
â”‚ â€¢ To extract visual: img_tokens = x[:, 512:, :]                                                             â”‚
â”‚ â€¢ To extract text: txt_tokens = x[:, :512, :]                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

SINGLE-STREAM PROCESSING: 38 Ã— SingleStreamBlock  
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ for block in self.single_blocks:  # model.py:114-115                                                        â”‚
â”‚     img = block(img, vec=vec, pe=pe)                                                                        â”‚
â”‚                                                                                                             â”‚
â”‚    EACH SingleStreamBlock (layers.py:194-239): PARALLEL ARCHITECTURE                                        â”‚
â”‚                                                                                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                                                     â”‚
â”‚ â”‚ UNIFIED SEQUENCE    â”‚ â† Input: [B, 512 + HÃ—W/4, hidden_size]                                              â”‚
â”‚ â”‚ [txt_tokens |       â”‚   Contains both text and visual tokens                                              â”‚
â”‚ â”‚  img_tokens]        â”‚                                                                                     â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                                                     â”‚
â”‚         â”‚                                                                                                   â”‚
â”‚         â–¼                                                                                                   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                                                     â”‚
â”‚ â”‚ Vector Modulation   â”‚                                                                                     â”‚
â”‚ â”‚ mod, _ = modulation â”‚                                                                                     â”‚
â”‚ â”‚ (vec)               â”‚                                                                                     â”‚
â”‚ â”‚ Returns single      â”‚                                                                                     â”‚
â”‚ â”‚ ModulationOut:      â”‚                                                                                     â”‚
â”‚ â”‚ â€¢ shift, scale, gateâ”‚                                                                                     â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                                                     â”‚
â”‚         â”‚                                                                                                   â”‚
â”‚         â–¼                                                                                                   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                                                     â”‚
â”‚ â”‚ Pre-Normalization   â”‚                                                                                     â”‚
â”‚ â”‚ x_mod = (1 +        â”‚                                                                                     â”‚
â”‚ â”‚   mod.scale) *      â”‚                                                                                     â”‚
â”‚ â”‚   pre_norm(x) +     â”‚                                                                                     â”‚
â”‚ â”‚   mod.shift         â”‚                                                                                     â”‚
â”‚ â”‚ LayerNorm applied   â”‚                                                                                     â”‚
â”‚ â”‚ to full sequence    â”‚                                                                                     â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                                                     â”‚
â”‚         â”‚                                                                                                   â”‚
â”‚         â–¼                                                                                                   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                                                     â”‚
â”‚ â”‚  PARALLEL SPLIT     â”‚ â† KEY EFFICIENCY INNOVATION!                                                        â”‚
â”‚ â”‚ qkv, mlp = split(   â”‚                                                                                     â”‚
â”‚ â”‚   linear1(x_mod),   â”‚                                                                                     â”‚
â”‚ â”‚   [3*hidden_size,   â”‚                                                                                     â”‚
â”‚ â”‚    mlp_hidden_dim], â”‚                                                                                     â”‚
â”‚ â”‚   dim=-1)           â”‚                                                                                     â”‚
â”‚ â”‚                     â”‚                                                                                     â”‚
â”‚ â”‚ linear1 projects to â”‚                                                                                     â”‚
â”‚ â”‚ 3*hidden + mlp_dim  â”‚                                                                                     â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                                                     â”‚
â”‚         â”‚                                                                                                   â”‚
â”‚    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”                                                                                             â”‚
â”‚    â–¼          â–¼                                                                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                               â”‚
â”‚ â”‚ ATTENTION PATH      â”‚               â”‚ MLP PATH            â”‚                                               â”‚
â”‚ â”‚ q,k,v = rearrange( â”‚                â”‚ mlp_out = mlp_act(  â”‚                                               â”‚
â”‚ â”‚   qkv, "B L (K H D) â”‚               â”‚   mlp)              â”‚                                               â”‚
â”‚ â”‚   -> K B H L D",    â”‚               â”‚ GELU activation     â”‚                                               â”‚
â”‚ â”‚   K=3, H=num_heads) â”‚               â”‚ [B, seq_len,        â”‚                                               â”‚
â”‚ â”‚                     â”‚               â”‚  mlp_hidden_dim]    â”‚                                               â”‚
â”‚ â”‚ q,k = norm(q,k,v)   â”‚ â† QK RMSNorm  â”‚                     â”‚                                               â”‚
â”‚ â”‚ QKNorm per head     â”‚               â”‚                     â”‚                                               â”‚
â”‚ â”‚                     â”‚               â”‚                     â”‚                                               â”‚
â”‚ â”‚ attn = attention(   â”‚               â”‚                     â”‚                                               â”‚
â”‚ â”‚   q, k, v, pe=pe)   â”‚               â”‚                     â”‚                                               â”‚
â”‚ â”‚ Full self-attention â”‚               â”‚                     â”‚                                               â”‚
â”‚ â”‚ on unified sequence â”‚               â”‚                     â”‚                                               â”‚
â”‚ â”‚ [B, seq_len, hidden]â”‚               â”‚                     â”‚                                               â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                               â”‚
â”‚         â”‚                                       â”‚                                                           â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                           â”‚
â”‚                       â–¼                                                                                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                                                     â”‚
â”‚ â”‚ PARALLEL COMBINE    â”‚                                                                                     â”‚
â”‚ â”‚ output = linear2(   â”‚                                                                                     â”‚
â”‚ â”‚   torch.cat((attn,  â”‚                                                                                     â”‚
â”‚ â”‚             mlp_out)â”‚                                                                                     â”‚
â”‚ â”‚            , dim=2))â”‚                                                                                     â”‚
â”‚ â”‚ Projects back to    â”‚                                                                                     â”‚
â”‚ â”‚ hidden_size         â”‚                                                                                     â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                                                     â”‚
â”‚         â”‚                                                                                                   â”‚
â”‚         â–¼                                                                                                   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                                                     â”‚
â”‚ â”‚ RESIDUAL CONNECTION â”‚                                                                                     â”‚
â”‚ â”‚ return x + mod.gate â”‚                                                                                     â”‚
â”‚ â”‚        * output     â”‚                                                                                     â”‚
â”‚ â”‚ Gated residual with â”‚                                                                                     â”‚
â”‚ â”‚ conditioning        â”‚                                                                                     â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                                                     â”‚
â”‚         â”‚                                                                                                   â”‚
â”‚         â–¼                                                                                                   â”‚
â”‚    Next block input                                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

VISUAL TOKEN EXTRACTION & OUTPUT STAGE
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ # Extract only visual tokens: model.py:116                                                                  â”‚
â”‚ img = img[:, txt.shape[1]:, ...]                                                                            â”‚
â”‚                                                                                                             â”‚
â”‚ ğŸ“Š EXTRACTION PROCESS:                                                                                      â”‚
â”‚ â€¢ Input: [B, 512 + HÃ—W/4, hidden_size] â† Unified sequence                                                   â”‚
â”‚ â€¢ txt.shape[1] = 512 â† Text sequence length                                                                 â”‚
â”‚ â€¢ Output: [B, HÃ—W/4, hidden_size] â† Pure visual tokens                                                      â”‚
â”‚                                                                                                             â”‚
â”‚         â”‚                                                                                                   â”‚
â”‚         â–¼                                                                                                   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                                                     â”‚
â”‚ â”‚ FINAL LAYER         â”‚                                                                                     â”‚
â”‚ â”‚ LastLayer           â”‚                                                                                     â”‚
â”‚ â”‚ layers.py:242-253   â”‚                                                                                     â”‚
â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                                                                                     â”‚
â”‚ â”‚ â”‚ AdaLN Modulationâ”‚ â”‚ â† Final conditioning with vector                                                    â”‚
â”‚ â”‚ â”‚ shift, scale =  â”‚ â”‚                                                                                     â”‚
â”‚ â”‚ â”‚ adaLN_mod(vec)  â”‚ â”‚                                                                                     â”‚
â”‚ â”‚ â”‚ .chunk(2, dim=1)â”‚ â”‚                                                                                     â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                                                                                     â”‚
â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                                                                                     â”‚
â”‚ â”‚ â”‚ Final LayerNorm â”‚ â”‚                                                                                     â”‚
â”‚ â”‚ â”‚ x = (1 + scale  â”‚ â”‚                                                                                     â”‚
â”‚ â”‚ â”‚   [:, None, :]) â”‚ â”‚                                                                                     â”‚
â”‚ â”‚ â”‚   * norm_final  â”‚ â”‚                                                                                     â”‚
â”‚ â”‚ â”‚   (x) + shift   â”‚ â”‚                                                                                     â”‚
â”‚ â”‚ â”‚   [:, None, :]  â”‚ â”‚                                                                                     â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                                                                                     â”‚
â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                                                                                     â”‚
â”‚ â”‚ â”‚ Linear Project  â”‚ â”‚                                                                                     â”‚
â”‚ â”‚ â”‚ x = linear(x)   â”‚ â”‚                                                                                     â”‚
â”‚ â”‚ â”‚ hidden_size â†’   â”‚ â”‚                                                                                     â”‚
â”‚ â”‚ â”‚ patch_sizeÂ² *   â”‚ â”‚                                                                                     â”‚
â”‚ â”‚ â”‚ out_channels    â”‚ â”‚                                                                                     â”‚
â”‚ â”‚ â”‚ = 1Â² * 16 = 16  â”‚ â”‚                                                                                     â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                                                                                     â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                                                     â”‚
â”‚         â”‚                                                                                                   â”‚
â”‚         â–¼                                                                                                   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                                                     â”‚
â”‚ â”‚ VELOCITY FIELD      â”‚ â† This is the MODEL OUTPUT for flow matching!                                       â”‚
â”‚ â”‚ [B, HÃ—W/4, 16]      â”‚   NOT noise like traditional diffusion                                              â”‚
â”‚ â”‚ Flow prediction     â”‚                                                                                     â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                                                     â”‚
â”‚         â”‚                                                                                                   â”‚
â”‚         â–¼                                                                                                   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                                                     â”‚
â”‚ â”‚ DENOISE INTEGRATION â”‚ â† Used in sampling loop                                                             â”‚
â”‚ â”‚ sampling.py:266-267 â”‚                                                                                     â”‚
â”‚ â”‚ img = img + (t_prev â”‚                                                                                     â”‚
â”‚ â”‚   - t_curr) * pred  â”‚   Euler method integration                                                          â”‚
â”‚ â”‚ Rectified flow      â”‚                                                                                     â”‚
â”‚ â”‚ straight-line path  â”‚                                                                                     â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                                                     â”‚
â”‚         â”‚                                                                                                   â”‚
â”‚         â–¼ (After sampling loop completes)                                                                   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                                                     â”‚
â”‚ â”‚ SPATIAL UNPACKING   â”‚                                                                                     â”‚
â”‚ â”‚ sampling.py:274-282 â”‚                                                                                     â”‚
â”‚ â”‚ unpack(x, h, w):    â”‚                                                                                     â”‚
â”‚ â”‚ rearrange(x,        â”‚                                                                                     â”‚
â”‚ â”‚ "b (h w)(c ph pw) â†’ â”‚                                                                                     â”‚
â”‚ â”‚  b c (h ph)(w pw)", â”‚                                                                                     â”‚
â”‚ â”‚ h=ceil(height/16),  â”‚                                                                                     â”‚
â”‚ â”‚ w=ceil(width/16),   â”‚                                                                                     â”‚
â”‚ â”‚ ph=2, pw=2)         â”‚                                                                                     â”‚
â”‚ â”‚ Result: [B,16,H/8,W/8]                                                                                    â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                                                     â”‚
â”‚         â”‚                                                                                                   â”‚
â”‚         â–¼                                                                                                   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                                                     â”‚
â”‚ â”‚ VAE DECODING        â”‚                                                                                     â”‚
â”‚ â”‚ autoencoder.py:352  â”‚                                                                                     â”‚
â”‚ â”‚ z = z / scale_factorâ”‚                                                                                     â”‚
â”‚ â”‚     + shift_factor  â”‚                                                                                     â”‚
â”‚ â”‚ decoder(z)          â”‚                                                                                     â”‚
â”‚ â”‚ 16 channels â†’       â”‚                                                                                     â”‚
â”‚ â”‚ 3 RGB channels      â”‚                                                                                     â”‚
â”‚ â”‚ H/8,W/8 â†’ H,W       â”‚                                                                                     â”‚
â”‚ â”‚ Final:[B,3,H,W]     â”‚                                                                                     â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
